<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Becoffee | Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="site/styles.css" />
</head>

<body>

  <header class="header">
    <div class="container d-flex justify-content-between align-items-center py-3">
      <div class="nav-left d-flex gap-3">
        <a href="/">Home</a>
        <a href="/menu">Menu</a>
        <a href="/cart">Cart</a>
      </div>
      <div class="nav-right">
        <a href="/login" id="userBadge">Login</a>
      </div>
    </div>
  </header>

  <main class="container py-5">
    <div class="row g-4">

      <!-- LEFT -->
      <div class="col-md-7">
        <div class="checkout-card p-4">
          <h3>Shipping & Payment</h3>

          <form id="checkoutForm" class="mt-4">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input id="fullName" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input id="phone" type="tel" class="form-control" required>
              </div>

              <div class="col-12">
                <label class="form-label">Address</label>
                <input id="address" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">City</label>
                <input id="city" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">State</label>
                <input id="state" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Zip</label>
                <input id="zip" class="form-control" required>
              </div>
            </div>

            <!-- PAYMENT METHOD -->
            <div class="mt-4">
              <label class="form-label">Payment Method</label>
              <select id="paymentMethod" class="form-select">
                <option value="cod">Cash on Delivery</option>
                <option value="card">Card</option>
              </select>
            </div>

            <!-- CARD DETAILS -->
            <div id="cardDetails" class="mt-4 d-none">
              <h5>Card Details</h5>

              <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input id="cardNumber" class="form-control" maxlength="19">
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Expiry Date</label>
                  <input id="expiry" class="form-control" placeholder="MM/YY">
                </div>
                <div class="col-md-6">
                  <label class="form-label">CVV</label>
                  <input id="cvv" class="form-control" maxlength="4">
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Name on Card</label>
                <input id="cardName" class="form-control">
              </div>
            </div>

            <button class="btn btn-dark mt-4 w-100">
              Place Order
            </button>

          </form>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="col-md-5">
        <div class="checkout-card p-4">
          <h4>Order Summary</h4>
          <div id="cartSummary" class="mt-3"></div>

          <!-- DISCOUNT COUPON SECTION -->
          <div class="mt-4 pt-3 border-top">
            <label class="form-label">Discount Coupon</label>
            <div class="input-group mb-3">
              <input type="text" id="couponCode" class="form-control" placeholder="Enter coupon code">
              <button class="btn btn-outline-secondary" type="button" id="applyCoupon">Apply</button>
            </div>
            <div id="couponMessage" class="small"></div>
          </div>

        </div>
      </div>

    </div>
  </main>

  <footer class="text-center py-4">
    © 2025 Becoffee | Crafted with coffee & code.
  </footer>

  <script src="site/app.js"></script>

  <script>
    // Auth check
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    hydrateUserBadge('userBadge');

    const cartSummary = document.getElementById('cartSummary');
    const paymentSelect = document.getElementById('paymentMethod');
    const cardDetails = document.getElementById('cardDetails');
    const fullName = document.getElementById('fullName');
    const email = document.getElementById('email');
    const phone = document.getElementById('phone');
    const address = document.getElementById('address');
    const city = document.getElementById('city');
    const state = document.getElementById('state');
    const zip = document.getElementById('zip');

    // Coupon elements
    const couponInput = document.getElementById('couponCode');
    const applyBtn = document.getElementById('applyCoupon');
    const couponMessage = document.getElementById('couponMessage');

    let discountPercent = 0;
    let appliedCoupon = '';

    // Toggle card form
    paymentSelect.addEventListener('change', () => {
      cardDetails.classList.toggle('d-none', paymentSelect.value !== 'card');
    });

    // Load cart from localStorage
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    function renderSummary() {
      if (!cart.length) {
        cartSummary.innerHTML = '<p>Your cart is empty</p>';
        return;
      }

      let subtotal = 0;
      const itemsHtml = cart.map(item => {
        const itemTotal = (item.price || 0) * (item.quantity || 1);
        subtotal += itemTotal;
        return `
        <div class="d-flex justify-content-between mb-2">
          <span>${item.name} × ${item.quantity || 1}</span>
          <span>Rs ${itemTotal.toFixed(2)}</span>
        </div>
      `;
      }).join('');

      const discountAmount = subtotal * discountPercent;
      const total = subtotal - discountAmount;

      let summaryHtml = itemsHtml + '<hr>';

      // Add subtotal if discount applied
      if (discountPercent > 0) {
        summaryHtml += `
        <div class="d-flex justify-content-between mb-2 text-muted">
          <span>Subtotal</span>
          <span>Rs ${subtotal.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-success">
          <span>Discount (${(discountPercent * 100).toFixed(0)}%)</span>
          <span>-Rs ${discountAmount.toFixed(2)}</span>
        </div>
      `;
      }

      summaryHtml += `
      <div class="d-flex justify-content-between font-weight-bold">
        <strong>Total</strong>
        <strong>Rs ${total.toFixed(2)}</strong>
      </div>
    `;

      cartSummary.innerHTML = summaryHtml;
    }

    // Initial render
    renderSummary();

    // Coupon Logic
    applyBtn.addEventListener('click', () => {
      const code = couponInput.value.trim().toUpperCase();
      if (code === 'SAVE10') {
        discountPercent = 0.10;
        appliedCoupon = 'SAVE10';
        couponMessage.textContent = 'Coupon applied successfully! 10% off.';
        couponMessage.className = 'small text-success';
      } else if (code === '') {
        discountPercent = 0;
        appliedCoupon = '';
        couponMessage.textContent = '';
        couponMessage.className = 'small';
      } else {
        discountPercent = 0;
        appliedCoupon = '';
        couponMessage.textContent = 'Invalid coupon code.';
        couponMessage.className = 'small text-danger';
      }
      renderSummary();
    });

    document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!cart.length) {
        alert('Your cart is empty');
        return;
      }

      // Calculate totals
      const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
      const taxPrice = 0; // Keeping simple as per user code, but typically calc server side
      const shippingPrice = 0; // Free shipping

      // Recalculate discount
      const discountAmount = subtotal * discountPercent;
      const itemsPrice = subtotal - discountAmount; // Effective price after discount
      const totalPrice = itemsPrice + taxPrice + shippingPrice;

      // Prepare order items with all required fields
      const orderItems = cart.map(item => ({
        product: item._id || item.id,
        name: item.name,
        quantity: item.quantity || 1,
        price: item.price || 0,
        image: item.image || ''
      }));

      // Prepare shipping address matching backend schema
      const shippingAddress = {
        fullName: fullName.value,
        street: address.value,
        city: city.value,
        state: state.value,
        zipCode: zip.value,
        country: 'Pakistan',
        phone: phone.value
      };

      // Map payment method: cod -> cash
      let paymentMethod = paymentSelect.value;
      if (paymentMethod === 'cod') {
        paymentMethod = 'cash';
      }

      try {
        const order = await api('/orders', {
          method: 'POST',
          body: {
            orderItems,
            shippingAddress,
            paymentMethod,
            itemsPrice: itemsPrice, // Send discounted price as itemsPrice or subtotal
            taxPrice: taxPrice,
            shippingPrice: shippingPrice,
            totalPrice: totalPrice,
            coupon: appliedCoupon // Optional: send coupon code to backend if needed for record
          }
        });

        localStorage.removeItem('cart');
        window.location.href = '/thankyou';

      } catch (err) {
        console.error(err);
        alert(err.message || 'Order failed');
      }
    });
  </script>

</body>

</html>