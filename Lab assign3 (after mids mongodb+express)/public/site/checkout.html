<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Becoffee | Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="site/styles.css" />
</head>

<body>

  <header class="header">
    <div class="container d-flex justify-content-between align-items-center py-3">
      <div class="nav-left d-flex gap-3">
        <a href="/">Home</a>
        <a href="/menu">Menu</a>
        <a href="/cart">Cart</a>
      </div>
      <div class="nav-right">
        <a href="/login" id="userBadge">Login</a>
      </div>
    </div>
  </header>

  <main class="container py-5">
    <div class="row g-4">

      
      <div class="col-md-7">
        <div class="checkout-card p-4">
          <h3>Shipping & Payment</h3>

          <form id="checkoutForm" class="mt-4">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input id="fullName" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input id="phone" type="tel" class="form-control" required>
              </div>

              <div class="col-12">
                <label class="form-label">Address</label>
                <input id="address" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">City</label>
                <input id="city" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">State</label>
                <input id="state" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Zip</label>
                <input id="zip" class="form-control" required>
              </div>
            </div>

            
            <div class="mt-4">
              <label class="form-label">Payment Method</label>
              <select id="paymentMethod" class="form-select">
                <option value="cod">Cash on Delivery</option>
                <option value="card">Card</option>
              </select>
            </div>

            
            <div id="cardDetails" class="mt-4 d-none">
              <h5>Card Details</h5>

              <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input id="cardNumber" class="form-control" maxlength="19">
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Expiry Date</label>
                  <input id="expiry" class="form-control" placeholder="MM/YY">
                </div>
                <div class="col-md-6">
                  <label class="form-label">CVV</label>
                  <input id="cvv" class="form-control" maxlength="4">
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Name on Card</label>
                <input id="cardName" class="form-control">
              </div>
            </div>

            <button class="btn btn-dark mt-4 w-100">
              Place Order
            </button>

          </form>
        </div>
      </div>

      
      <div class="col-md-5">
        <div class="checkout-card p-4">
          <h4>Order Summary</h4>
          <div id="cartSummary" class="mt-3"></div>
        </div>
      </div>

    </div>
  </main>

  <footer>
    <div class="row">
      <div class="le">
        <h9>Bibendum auctor</h9>
        <p>
          Sed ut imperdiet nisi. Proin condimentum fermentum nunc. Etiam pharetra, erat sed fermentum feugiat, velit
          mauris egestas quam, ut aliquam massa nisl quis neque.
        </p>
      </div>
      <div class="mi">
        <h9>Aliquam erat</h9>
        <p>
          Proin gravida nibh vel velit auctor aliquet. Aenean sollicitudin, lorem quis bibendum auctor, nisi elit
          consequat ipsum, nec sagittis sem nibh id elit. Duis sed odio sit amet.
        </p>
      </div>
      <div class="ri">
        <h9>Nullam wisi</h9>
        <p>
          Nullam viverra consectetuer. Quisque cursus et, porttitor risus. Aliquam sem. In hendrerit nulla quam nunc,
          accumsan congue. Lorem ipsum primis in nibh vel risus. Sed vel lectus.
        </p>
      </div>
    </div>


    <script src="site/app.js"></script>

    <script>
      ensureAuthOrRedirect();
      hydrateUserBadge('userBadge');

      const cartSummary = document.getElementById('cartSummary');
      const paymentSelect = document.getElementById('paymentMethod');
      const cardDetails = document.getElementById('cardDetails');
      const fullName = document.getElementById('fullName');
      const email = document.getElementById('email');
      const phone = document.getElementById('phone');
      const address = document.getElementById('address');
      const city = document.getElementById('city');
      const state = document.getElementById('state');
      const zip = document.getElementById('zip');

      // Toggle card form
      paymentSelect.addEventListener('change', () => {
        cardDetails.classList.toggle('d-none', paymentSelect.value !== 'card');
      });

      // Load cart from localStorage
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      if (!cart.length) {
        cartSummary.innerHTML = '<p>Your cart is empty</p>';
      } else {
        let total = 0;
        cartSummary.innerHTML = cart.map(item => {
          total += item.price * item.quantity;
          return `
        <div class="d-flex justify-content-between mb-2">
          <span>${item.name} Ã— ${item.quantity}</span>
          <span>Rs ${item.price * item.quantity}</span>
        </div>
      `;
        }).join('') + `<hr><strong>Total: Rs ${total}</strong>`;
      }

      document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!cart.length) {
          alert('Your cart is empty');
          return;
        }

        // Calculate totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const taxPrice = subtotal * 0.10; // 10% tax
        const shippingPrice = 0; // Free shipping
        const totalPrice = subtotal + taxPrice + shippingPrice;

        // Prepare order items with all required fields
        const orderItems = cart.map(item => ({
          product: item._id || item.id,
          name: item.name,
          quantity: item.quantity,
          price: item.price,
          image: item.image || ''
        }));

        // Prepare shipping address matching backend schema
        const shippingAddress = {
          fullName: fullName.value,
          street: address.value,
          city: city.value,
          state: state.value,
          zipCode: zip.value,
          country: 'Pakistan',
          phone: phone.value
        };

        // Map payment method: cod -> cash
        let paymentMethod = paymentSelect.value;
        if (paymentMethod === 'cod') {
          paymentMethod = 'cash';
        }

        try {
          const order = await api('/orders', {
            method: 'POST',
            body: JSON.stringify({
              orderItems,
              shippingAddress,
              paymentMethod,
              itemsPrice: subtotal,
              taxPrice: taxPrice,
              shippingPrice: shippingPrice,
              totalPrice: totalPrice
            })
          });

          localStorage.removeItem('cart');
          window.location.href = '/thankyou';

        } catch (err) {
          alert(err.message);
        }
      });
    </script>

</body>

</html>